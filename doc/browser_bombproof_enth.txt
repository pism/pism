/*! \page bombproofenth BOMBPROOF, a numerical scheme for conservation of energy

\section intro Introduction

One of the essential goals for any thermomechanically-coupled numerical ice sheet model is a completely bombproof numerical scheme for the advection-conduction-reaction problem for the conservation of energy within the ice and the bedrock.  "Bombproof" means being, roughly, as stable as possible in as many realistic modeling contexts as possible.  PISM's scheme is observed to be highly robust in practice, but it is also provably stable in a significant range of circumstances.  The scheme is special to shallow ice sheets because it makes specific tradeoff choices with respect to vertical velocity, though it is generic (and low order) with respect to horizontal velocity.  In this page we will state the scheme, prove its stability properties, and specify the nontrivial modifications needed at the ice-bedrock transition.

Accuracy is necessarily a second goal.  It is partly achieved 
here because our scheme has truncation error \f$O(\Delta z^2)\f$
in many circumstances, though it reverts to lower order when it "detects trouble"
in the form of large vertical velocities.  More completely stated, the scheme has 
order \f$O(\Delta t,\Delta x,\Delta y, \Delta z^2)\f$ in circumstances where the vertical
ice flow velocity is small enough, relative to conductivity, and otherwise reverts to 
order \f$O(\Delta t,\Delta x,\Delta y, \Delta z^1)\f$.

The conservation of energy problem here is described in terms of the enthalpy
field for the ice and in terms of temperature for the bedrock.  The finite
difference scheme here supercedes the PISM scheme for the 
temperature equation described in the appendices of [\ref BBL].  That scheme 
is robust but it has a CFL condition on \e vertical advection, an avoidable time step 
restriction.  The CFL condition on \e horizontal advection
remains in the new scheme, however.  The scheme here is conditionally stable 
as an adaptive time-stepping technique for the 3D conservation of energy equation.
The length of the time step is limited only by the maximum magnitude of the 
horizontal velocities within the ice.

The ice %region in which the energy equation needs to be solved, at least within 
the ice sheet and attached ice shelves, generally changes over time.  This is an 
essential complicating factor in ice sheet modeling.  According to user options, 
there may also be a model for the energy within a layer of bedrock 
below the ice sheet.  The implementation must accommodate these possibilities.
Equally essential is the fact that the velocity field has a
complicated provenance.  It comes from a variety of stress
balance equations.  These stress balances, especially where there is a transition 
in flow type, for instance at grounding lines, are incompletely understood
when thermomechanically coupled.  The stress balance could be the SIA, the
SSA, a mix of these in different parts of the ice sheet/shelf system, or
other stress balances in future PISM versions.

We need to \e not make, and we will not make in proving stability, assumptions
about the regularity of the velocity field in space or time.  Beyond boundedness,
that is.  Nor do we want the numerical scheme for advection to need any
information about the velocity except its value at the beginning of the time
step.  Thus we would not accept a scheme which required the Jacobian
of the velocity field with respect to changes in energy, for example.
At very least we cannot implement a fully-implicit scheme without some 
blind iteration (%e.g. with no guarantee of convergence of the iteration).
The scheme we propose involves no such iteration.


\section iceequations Conservation of energy in a shallow ice sheet

In terms of the ice specific enthalpy field \f$E(x,y,z,t)\f$, which has units of 
\f$\text{J}\,\text{kg}^{-1}\f$ in SI, the energy equation is
\anchor basicEnergy
  \f[ \rho \frac{dE}{dt} = -\nabla \cdot \mathbf{q} + Q,\tag{basicEnergy} \f]
where \f$\rho\f$ is the material density.  The units of equation
(\ref basicEnergy), and of the quantity \f$Q\f$ described below, are
\f$J\,\text{s}^{-1}\,\text{m}^{-3}\f$ in SI.

The heat flux in cold ice and temperate ice is [\ref AschwandenBlatter]
\anchor heatflux
  \f[ \mathbf{q} = \begin{cases}
                      - k_i c_i^{-1} \nabla E, & \text{cold ice}, \\
                      0, & \text{temperate ice}, \tag{heatflux} \\
                   \end{cases} \f]
where \f$k_i,c_i\f$ are constant.  (In fact we may consider nonzero flux in the temperate ice case, either conceptualized as a regularization of the "real" equation, or as a flux of latent heat carried by liquid water.)  Note \f$dE/dt\f$ stands for the material derivative of the enthalpy field, so the expanded form of (\ref basicEnergy) is
  \f[ \rho \left(\frac{\partial E}{\partial t} + \mathbf{U}\cdot \nabla E\right)
        = -\nabla \cdot \mathbf{q} + Q, \f]
where \f$\mathbf{U}\f$ is the three dimensional velocity.  Three-dimensional advection is included.

The additive quantity \f$Q\f$ is the dissipation (strain-rate) heating.  Without making any shallow approximations, the exact formula for this is
  \f[ Q = \sum_{i,j=1}^3 D_{ij} \tau_{ij} \f] 
where \f$D_{ij}\f$ is the strain rate tensor and \f$\tau_{ij}\f$ is the deviatoric stress tensor.  References [\ref BBL, \ref BBssasliding] address how this term is computed in PISM, according to the shallow stress balance approximations.
(Within the source code, see methods IceModel::velocitySIAStaggered() and
IceModel::correctSigma().  Note \f$Q\f$ was called \f$\Sigma\f$ in the just-mentioned references.)

In a sliding model with an ice-bedrock interface, the friction of the sliding also is a source of heating.  It has units of W m-2 = J s-1 m-2, that is, the same units as the heat flux \f$\mathbf{q}\f$ above.  In formulas we write
  \f[ F_b = - \tau_b \cdot \mathbf{u}_b, \f]
where \f$\tau_b\f$ is the basal shear stress and \f$\mathbf{u}_b\f$ is the basal sliding velocity.  The basal shear stress is oppositely-directed to the basal velocity.  (For example, in the plastic case \f$\tau_b = - \tau_c \mathbf{u}_b / |\mathbf{u}_b|\f$ where \f$\tau_c\f$ is a positive scalar, the yield stress.)  The friction heating is concentrated at \f$z=0\f$, and it enters into the basal boundary condition, the flux jump condition addressed in section \ref melt below.

We use a shallow approximation of equation (\ref basicEnergy).  It lacks horizontal
conduction terms  [\ref Fowler].  For the initial analysis of the core BOMBPROOF
scheme, we specialize to cold ice and we do not consider the bedrock thermal layer,
which is returned to later (below).  Therefore, within cold ice, the coefficient in the heat
flux is constant, so
  \f[ \nabla \cdot \mathbf{q} = - k_i c_i^{-1} \frac{\partial^2 E}{\partial z^2}. \f]
Therefore the equation we initially analyze is

\anchor basicShallow
\f[
\rho_i \left(\frac{\partial E}{\partial t} + \mathbf{U}\cdot \nabla E\right) = k_i c_i^{-1} \frac{\partial^2 E}{\partial z^2} + Q,\tag{basicShallow}
\f]

We will assume, of course, that \f$\rho_i\f$ and \f$c_i\f$ are positive.

We will be focusing on the direction in which the enthalpy and temperature has largest spatial gradient, 
namely with respect to the vertical coordinate \f$z\f$.  Rewriting equation (\ref basicShallow)
to emphasize the vertical terms we have

\anchor vertProblem
\f{align*}
\rho_i \left(\frac{\partial E}{\partial t} + w \frac{\partial E}{\partial z}\right) 
     &= k_i c_i^{-1}  \frac{\partial^2 E}{\partial z^2} + \Phi \tag{vertProblem}
 \f}
where
\f[
\Phi = Q - \rho_i \left(u \frac{\partial E}{\partial x}
                         + v \frac{\partial E}{\partial y}\right)
\f]

The boundary conditions to problem (\ref vertProblem) are a surface temperature
condition at the top of the ice and a geothermal flux condition at the bottom of the ice.
(Only at the end will we consider the bedrock thermal layer.)  Within cold ice
the enthalpy and the temperature are linearly related,
  \f[ T(E,p) = c_i^{-1} (E-E_s(p)) + T_m(p) = c_i^{-1} E, \f]
because the enthalpy is normalized by \f$E_s(p) = c_i T_m(p)\f$.  (See documentation
on the EnthalpyConverter class.)  We will assume that in reasonably-realistic
ice sheet modeling situations the surface temperature \f$T_s(t,x,y)\f$ (K) and
the geothermal flux \f$G(t,x,y)\f$ (W m-2) are given.  Thus for cold ice, and no
bedrock thermal layer,
\anchor columnbcs
\f[
E(t,z=H) = c_i T_s, \qquad -k_i c_i^{-1} \frac{\partial E}{\partial z}\Big|_{z=0} = G.\tag{columnbcs}
\f]
(The more complete story for this boundary condition is given in section \ref melt below.)


\section corebombproof The core BOMBPROOF scheme

For the discussion of the numerical scheme below, let \f$E_{ijk}^n\f$ be our approximation to 
the exact enthalpy \f$E\f$ at the grid point with coordinates \f$(x_i,y_j,z_k)\f$ at 
time \f$t_n\f$.  When \f$i,j\f$ are uninteresting we will suppress them and write \f$E_k^n\f$.  
We will use similar notation for numerical approximations to the other quantities, including
velocity components \f$u,v,w\f$ and \f$\Phi\f$.  We put the horizontal advection terms in 
the source term \f$\Phi\f$ because we treat them explicitly, evaluating at time \f$t_n\f$.
(Implicit or semi-implicit treatment of horizontal advection would
require a coupled system distributed across processors.  That kind of numerical difficulty
can be avoided, even given the other constraints on accuracy and implementation.)

The scheme we use for horizontal advection is explicit first-order upwinding.  There is a CFL condition for the scheme to be stable, in the absence of conduction, and it is based on the magnitude of the horizontal velocity components.  To state the upwind scheme itself, let
  \f[\Up{f_{\bullet}}{\alpha_i} = \begin{cases}
                                     f_i-f_{i-1}, & \alpha_i\ge 0, \\
                                     f_{i+1}-f_i, & \alpha_i<0.
                                  \end{cases}\f]
The approximate horizontal advection terms, and thus the approximation to the whole
term \f$\Phi\f$, are
	\f[\Phi_{ijk}^n = \Sigma_{ijk}^n - \rho_i 
	                   \left( u_{ijk}^n\,\frac{\Up{E_{\bullet jk}^n}{u_{ijk}^n}}{\Delta x}
	                          + v_{ijk}^n\,\frac{\Up{E_{i\bullet k}^n}{v_{ijk}^n}}{\Delta y} \right).\f]

The CFL stability condition for this part of the scheme is
\anchor CFL
\f[
    \Delta t \,\left( \left|\frac{u_{ijk}^n}{\Delta x}\right|
                           + \left|\frac{v_{ijk}^n}{\Delta y}\right| \right) \le 1.\tag{CFL}
\f]
The routine IceModel::computeMax3DVelocities() computes the 
maximum of velocity magnitudes.  This produces a time step restriction based on 
the above CFL condition.  Then IceModel::determineTimeStep() 
implements adaptive time-stepping based on this and other stability criteria.

In the analysis below we will assume an equally-spaced grid \f$z_0,\dots,z_{M_z}\f$
with \f$\Delta z = z_{k+1} - z_k\f$.  In fact PISM has a remapping scheme in each 
column, wherein the enthalpy in a column of ice is stored on an unequally-spaced 
vertical grid, but is mapped to a fine, equally-spaced grid for the conservation
of energy computation described here.  (Similar structure applies to the age
computation.  See procedures IceEnthalpyModel::enthalpyAndDrainageStep() and
IceModel::ageStep(), and see the IceModelVec3 class and
IceGrid::get_fine_vertical_grid().  Options -z_spacing and -zb_spacing allow
choosing unequally-spaced storage vertical grids in ice and bedrock,
respectively.)

The \f$z\f$ derivative terms in (\ref vertProblem) will be approximated implicitly.  Let \f$\lambda\f$ be in the interval \f$0 \le \lambda \le 1\f$.  Suppressing indices \f$i,j\f$, the approximation to (\ref vertProblem) is
\anchor bombone
\f{align*}
\rho_i &\left( 
       \frac{E_k^{n+1} - E_k^n}{\Delta t}
       + \lambda w_k^n \frac{E_{k+1}^{n+1} - E_{k-1}^{n+1}}{2 \Delta z}
       + (1-\lambda) w_k^{n} \frac{\Up{E_{\bullet}^{n+1}}{w_k^{n}}}{\Delta z} \right) \\
     &= k_i c_i^{-1}\, \frac{E_{k+1}^{n+1} - 2 E_{k}^{n+1} + E_{k-1}^{n+1}}{\Delta z^2} + \Phi_k^n. \tag{bombone}
\f}

Equation (\ref bombone), along with a determination of \f$\lambda\f$ by (\ref lambdachoice) below, is the scheme BOMBPROOF.  It includes two approximations of vertical advection, combined with nonnegative coefficients which sum to one.  Both approximations are (semi-)implicit, but the centered formula has higher accuracy,
	\f[w_k^n \frac{E_{k+1}^{n+1} - E_{k-1}^{n+1}}{2 \Delta z}
	   = w \frac{\partial E}{\partial z} + O(\Delta t,\Delta z^2),\f]
while the first order upwind formula has lower accuracy,
	\f[w_k^{n} \frac{\Up{E_{\bullet}^{n+1}}{w_k^{n}}}{\Delta z}
	   = w \frac{\partial E}{\partial z} + O(\Delta t,\Delta z).\f]
We prefer for accuracy reasons to use the centered formula when possible, because it has higher order truncation error.  We only include (implicit) upwinding when it is needed for its added stability benefits.

Let
	\f[ \nu = \frac{\Delta t}{\Delta z},
	 \qquad \text{and} \qquad R = \frac{k_i \Delta t}{\rho_i c_i \Delta z^2}.\f]
We now rewrite (\ref bombone) for computational purposes as one of a system of equations 
for the unknowns \f$\{E_k^{n+1}\}\f$.  In the new system the coefficients will be
scaled so that the diagonal entries of the matrix have limit one as
\f$\Delta t\to 0\f$.  That is, we multiply equation (\ref bombone) by
\f$\Delta t\f$, divide it by \f$\rho_i\f$, and rearrange:
\anchor bombtwo
\f{align*}
&\left(-R - \nu w_k^n \uppair{1-\lambda/2}{\lambda/2}\right) E_{k-1}^{n+1}  
   + \left(1 + 2 R + \nu w_k^n (1-\lambda) \uppair{+1}{-1}\right) E_k^{n+1} \tag{bombtwo} \\
&\qquad\qquad + \left(-R + \nu w_k^n \uppair{\lambda/2}{1-\lambda/2} \right) E_{k+1}^{n+1}
    = E_k^n + \Delta t \rho_i^{-1}\Phi_k^n 
\f}
Here \f$\uppair{a}{b} = a\f$ when \f$w_k^n\ge 0\f$ and \f$\uppair{a}{b} = b\f$ when \f$w_k^n < 0\f$.

Equations (\ref bombone) or (\ref bombtwo) each combine two unconditionally 
stable ways of approximating vertical advection, namely implicit centered difference 
(\f$\lambda = 1\f$) and implicit first-order upwinding (\f$\lambda=0\f$).  The combination 
is "convex" because the coefficients are nonnegative and sum to one.

Regarding scaling of the equations and units, Equation (\ref bombtwo)
has coefficients which are scaled to have no units.  Equation (\ref bombtwo) is 
ready to be put in the system managed by an enthSystemCtx instance.

One way of stating the stability of first-order upwinding is to say it satisfies a  "maximum principle" [\ref MortonMayers].  An example of a maximum principle for this kind of finite difference scheme is that if \f$U_{k-1}^n,U_k^n,U_{k+1}^n\f$ are adjacent gridded values of some abstract quantity at time step \f$t_n\f$, and if the next value satisfies the scheme
\anchor abstractexplicit
\f{equation}
  U_k^{n+1} = C_{-1} U_{k-1}^n + C_0 U_k^n + C_{+1} U_{k+1}^n \tag{abstractexplicit}
\f}
for <i>nonnegative</i> coefficients \f$C_i\f$ summing to one, \f$C_{-1} + C_0 + C_{+1} = 1\f$,  then it follows by the triangle inequality that
	\f[\min\{|U_{k-1}^n|, |U_k^n|, |U_{k+1}^n|\} 
	       \le |U_k^{n+1}| \le \max\{|U_{k-1}^n|, |U_k^n|, |U_{k+1}^n|\}.\f]
Thus a "wiggle" cannot appear in \f$\{U_k^{n+1}\}\f$ this abstract explicit scheme from smoother values \f$\{U_k^n\}\f$.  The proof below shows the corresponding "wiggle-free" property for scheme (\ref bombtwo).

However, the pure implicit centered difference scheme (\f$\lambda=1\f$), namely
\anchor centered
\f{align*}
&\left(-R - \nu w_k^n/2\right) E_{k-1}^{n+1} + \left(1 + 2 R\right) E_k^{n+1} \tag{centered} \\
&\qquad\qquad + \left(-R + \nu w_k^n/2\right) E_{k+1}^{n+1} 
              = E_k^n + \Delta t \rho_i^{-1}\Phi_k^n 
\f}
is <i>less stable</i> than implicit first-order upwinding.  It is less stable 
in the same sense that Crank-Nicolson is a less stable scheme than 
backwards Euler for the simplest heat equation \f$u_t = u_{xx}\f$ [\ref MortonMayers].
In fact, although oscillatory modes cannot grow exponentially under equation (\ref centered),
those modes <i>can</i> appear when none are present already, even in the homogeneous case
\f$\Phi_k^n=0\f$.


\section theory Stability properties of the BOMBPROOF scheme

We want to be precise about the phrase "unconditionally stable" for BOMBPROOF.
To do so we consider somewhat simplified cases which are amenable to analysis, and
we prove two stability properties.  These stability properties identify the
precise advantages of BOMBPROOF.

\subsection stabilitythm Theorem (stating the stability properties).
Assume, for the precise but limited assertion of this theorem,
that the surface temperature \f$T_s\f$ and the geothermal flux \f$G\f$ are constant 
in time.  Assume also that the entire source function \f$\Phi\f$ is identically zero 
(but see comments below).  Fix an equally-spaced vertical grid \f$z_0=0 < z_1 < \dots < z_N=H\f$,
so that the upper grid point coincides with the surface of the ice.  With these assumptions, if
\anchor lambdachoice
\f[
\lambda = \min\left\{1, \quad 
	               \min_{k=0,\dots,N}\left\{\frac{2 k_i}{|w_k^n| \rho_i c_i \Delta z}\right\}
	               \quad \right\},\tag{lambdachoice}
\f]
reset at each time step \f$n\f$, then scheme (\ref bombone, \ref bombtwo) is
unconditionally-stable in the following two senses:

<ol>

<li>  A maximum principle applies without further assumptions.</li>
 
<li>  Suppose we freeze the coefficients of the problem to have constant values in
time and space.  (Concretely, we assume that \f$\lambda\f$ is chosen independently
of the time step \f$n\f$, and that \f$\Delta t\f$ is the same for each time step.
We assume constant vertical velocity \f$w_k^n=w_0\f$.  We also consider a spatially-periodic
or unbounded version of our problem, with no boundary conditions.)
Then a von Neumann  analysis of the constant coefficient problem yields 
a growth factor less than one for all modes on the grid.
</li>
</ol>

\subsection remark Remarks.
The phrases <i>maximum principle</i> and <i>von Neumann analysis</i> will be precisely illustrated in the following proof.  Both approaches are in [\ref MortonMayers].  There is additional information on the von Neumann analysis of implicit finite difference methods for advection in [\ref Strikwerda].

These statements also apply in case \f$k_i=0\f$, in which case (\ref lambdachoice) implies \f$\lambda=0\f$, and the method reduces to implicit first-order upwinding.  (Implicit first-order upwinding has properties 1 and 2 [\ref Strikwerda].)  The case \f$k_i=0\f$ is relevant because it applies to temperate ice in which there is no assumed enthalpy conduction.  (One reasonable model for temperate ice is to assume no transport of the liquid fraction, whether diffusive transport or otherwise, and to ignor conduction along the temperature gradient, because the gradient is only from pressure-melting temperature differences.)

\subsection proofone Proof of 1.

In the case considered for the maximum principle, with \f$\Phi_k^n=0\f$, 
we can rewrite (\ref bombtwo) as
\anchor formax
\f{align*}
&\left(1 + 2 R + \nu w_k^n (1-\lambda) \uppair{+1}{-1}\right) E_k^{n+1} \\
&\qquad = E_k^n + \left(R + \nu w_k^n \uppair{1-\lambda/2}{\lambda/2}\right) E_{k-1}^{n+1}
                + \left(R - \nu w_k^n \uppair{\lambda/2}{1-\lambda/2}\right) E_{k+1}^{n+1}.
                \tag{formax}
\f}

We claim that with choice (\ref lambdachoice) for \f$0 \le \lambda \le 1\f$, all 
coefficients in (\ref formax) are nonnegative.  At one extreme, in 
the upwinding case (\f$\lambda=0\f$), all the coefficients are nonnegative.  Otherwise, note that
\f$\nu w_k^n (1-\lambda) \uppair{+1}{-1}\f$ is nonnegative for any valid value 
of \f$\lambda\f$ and for any value of \f$w_k^n\f$, noting the meaning of the \f$\uppair{+1}{-1}\f$
symbol.  Thus the coefficient on the left is always nonnegative.  The coefficient of 
\f$E_{k-1}^{n+1}\f$ is clearly nonnegative for any valid value of \f$\lambda\f$ if \f$w_k^n \ge 0\f$.
The coefficient of \f$E_{k+1}^{n+1}\f$ is clearly nonnegative for any valid value of \f$\lambda\f$ if 
\f$w_k^n \le 0\f$.

Therefore the only concerns are for the coefficient of \f$E_{k-1}^{n+1}\f$ when \f$w_k^n\le 0\f$ and the 
coefficient of \f$E_{k+1}^{n+1}\f$ when \f$w_k^n\ge 0\f$.  But if \f$\lambda\f$ is smaller than 
\f$2k_i/(|w_k^n| \rho_i c_i \Delta z)\f$ then 
\f{align*}
R - \nu |w_k^n| (\lambda/2) &= \frac{k_i \Delta t}{\rho_i c_i \Delta z^2}
	                                       - \frac{\Delta t |w_k^n|}{\Delta z} \frac{\lambda}{2}
	        &\ge \frac{k_i \Delta t}{\rho_i c_i \Delta z^2}
	            - \frac{\Delta t |w_k^n|}{\Delta z} \frac{k_i}{|w_k^n| \rho_i c_i \Delta z} = 0.
\f}

Thus all the coefficients in (\ref formax) are nonnegative.  On the other hand, in equation (\ref formax), all coefficients on the right side sum to
    \f[ 1+2R+\nu w_k^n \uppair{1-\lambda}{-1+\lambda} = 1+2R+\nu w_k^n (1-\lambda) \uppair{+1}{-1}, \f]
which is exactly the coefficient on the left side of (\ref formax).  It follows that
    \f[ E_k^{n+1} = a_k E_k^n + b_k E_{k-1}^{n+1} + c_k E_{k+1}^{n+1} \f]
where \f$a_k,b_k,c_k\f$ are positive and \f$a_k+b_k+c_k=1\f$.  Thus a maximum principle applies [\ref MortonMayers]. 
<b> END OF PROOF OF 1. </b> 

\subsection prooftwo Proof of 2.
As a von Neumann analysis is much more restrictive than the analysis above, we will be brief.  
Let's assume the velocity is downward, \f$w_0<0\f$; the other case is similar.  Equation
(\ref bombtwo) becomes 
\anchor prevon
\f{align*}
&\left(-R - \nu w_0 (\lambda/2)\right) E_{k-1}^{n+1}  
   + \left(1 + 2 R - \nu w_0 (1-\lambda)\right) E_k^{n+1} \\
&\qquad\qquad + \left(-R + \nu w_0 (1-\lambda/2) \right) E_{k+1}^{n+1}  = E_k^n.\tag{prevonN}
\f}

The heart of the von Neumann analysis is the substitution of a growing or decaying
(in time index \f$n\f$) oscillatory mode on the grid of spatial wave number \f$\mu\f$:
	\f[E_k^n = \sigma^n e^{i\mu\,(k\Delta z)}.\f]
Here \f$k\Delta z = z_k\f$ is a grid point.  Such a mode is a solution to (\ref prevon) 
if and only if
\f{align*}
\sigma\Big[  &(-R - \nu w_0(\lambda/2)) e^{-i\mu\Delta z}
	              + (1 + 2 R - \nu w_0 (1-\lambda)) \\
	           &\quad   + (-R  + \nu w_0 (\lambda/2)) e^{+i\mu\Delta z}
	                    + \nu w_0 (1-\lambda) e^{+i\mu\Delta z} \Big] = 1.
\f}
This equation reduces by standard manipulations to
	\f[\sigma = \frac{1}{1 + \left(4 R - 2 \nu w_0 (1-\lambda)\right)\cos^2(\mu \Delta z/2)
	                      + i\,\nu w_0 (1-\lambda/2)\sin(\mu\Delta z)}.\f]
Note \f$4 R - 2 \nu w_0 (1-\lambda) \ge 0\f$ without restrictions on 
numerical parameters \f$\Delta t\f$, \f$\Delta z\f$, because \f$w_0<0\f$ in the 
case under consideration.  Therefore
	\f[|\sigma|^2 = \frac{1}{\left[1 + \left(4 R - 2 \nu w_0 (1-\lambda)\right)
	                              \cos^2(\mu \Delta z/2)\right]^2
	                      + \left[\nu w_0 (1-\lambda/2)\sin(\mu\Delta z)\right]^2}.\f]
This positive number is less than one, so \f$|\sigma| < 1\f$.  It follows that all
modes decay exponentially.  <b> END OF PROOF OF 2. </b>


\subsection remarktwo Remark about our von Neumann stability analysis.

The constant \f$\lambda\f$ is carefully chosen in (\ref lambdachoice) so that the maximum principle 1 applies.  On the other hand, both the implicit first-order upwind and the implicit centered difference formulas have unconditional stability in the von Neumann sense.  The proof of case 2 above is thus a formality, merely showing that a convex combination of unconditionally stable (von Neumann sense) schemes is still unconditionally stable in the same sense.


\subsection maxconsequence Convergence: a consequence of the maximum principle.
 
If we define the pointwise numerical error \f$e_k^n = E_k^n - E(t_n,x_i,y_j,z_k)\f$,
where \f$E(\dots)\f$ is the unknown exact solution (exact enthalpy field) [\ref MortonMayers],
then (\ref formax) implies an equality of the form
	\f[A e_k^{n+1} = e_k^n + B_- e_{k-1}^{n+1} + B_+ e_{k+1}^{n+1} + \Delta t\, \tau_k^n\f]
where \f$\tau_k^n\f$ is the truncation error of the scheme and \f$A,B_\pm\f$ are nonnegative  coefficients, which need no detail for now other than to note that \f$1 + B_- + B_+ = A\f$.  Letting \f${\bar e}^n = \max_k |e_k^n|\f$ we have, because of the positivity of coefficients,
\anchor prebound
\f{equation}
A |e_k^{n+1}| \le {\bar e}^n + \left(B_- + B_+\right){\bar e}^{n+1} + \Delta t\,\bar\tau^n \tag{prebound}
\f}
for all \f$k\f$, where \f$\bar\tau^n = \max_k |\tau_k^n|\f$.  Now let \f$k\f$ be the index for 
which \f$|e_k^{n+1}| = {\bar e}^{n+1}\f$.  For that \f$k\f$ we can replace \f$|e_k^{n+1}|\f$ in 
equation (\ref prebound) with \f${\bar e}^{n+1}\f$.  Subtracting the same quantity from 
each side of the resulting inequality gives
\f[
{\bar e}^{n+1} \le {\bar e}^n + \Delta t\,\bar\tau^n,
\f]
It follows that \f$\bar e^n \le C \Delta t\f$, for some finite \f$C\f$, if \f$\bar e^0 = 0\f$
[\ref MortonMayers].  Thus a maximum principle for BOMBPROOF implies convergence 
in the standard way [\ref MortonMayers].  This convergence proof has the same
assumptions as case 1 in the theorem, and thus it only \e suggests convergence
in any broad range of glaciologically-interesting cases.


\subsection final Remark on nonzero source term.

Now recall we assumed in Theorem 1 that the entire "source" \f$\Phi_k^n\f$ was identically zero.
Of course this is not realistic.  What we understand is provable, however, is that if a
numerical scheme for a linear advection/conduction equation
	\f[u_t + A u_x = B u_{xx}\f]
is stable in the general sense of numerical schemes for partial differential equations
(%e.g. as defined in subsection 5.5 of [\ref MortonMayers]) then the same scheme is stable 
in the same general sense when applied to the equation with (linear) lower order terms:
	\f[u_t + A u_x = B u_{xx} + C u + D.\f]
A precise statement of this general fact is hard to find in the literature, 
to put it mildly, but theorem 2.2.3 of [\ref Strikwerda] is one interesting case
(\f$B=0\f$ and \f$D=0\f$).  But even the form we state with linear term (\f$C u + D\f$)
is not adequate to the job because of the strongly-nonlinear dependence of \f$\Phi\f$
on the temperature \f$T\f$ [\ref BBL].

Nonetheless the maximum principle is a highly-desirable form of stability because we can exclude "wiggles" from the finite difference approximations of the conductive and advective terms, even if the complete physics, with strain heating in particular, is not yet shown to be non-explosive [\ref BBL].  Recall that, because we use first-order upwinding on the horizontal advection terms, we can expect maximum principle-type stability behavior of the whole three-dimensional scheme.


\section bedrock A finite difference scheme for the bedrock thermal layer

Realistic ice sheet modeling requires the recognition that, because sensible heat flux is proportional to temperature differences, the time-dependent geothermal contribution to the energy in the ice sheet, at the base, is related to the temperature in the ice itself.  This is a feedback mechanism that can, and should, for completeness, be modeled  [\ref RitzFabreLetreguilly].

For instance, suppose the ice sheet is in a balanced state in which the geothermal flux deep in the crust is equal to the heat flux into the ice base.  If the near-surface ice cools from this state then, because the ice temperature gradient is now greater in magnitude, between the warm bedrock and the cooler ice, the ice will for some period receive more than the deep geothermal flux rate. Similarly, if the ice warms from the balanced state then the temperature difference with the bedrock has become smaller and the magnitude of the ice basal heat flux will be less than the deep geothermal rate.

Because the relevant layer of bedrock below an ice sheet is again very shallow, and because we can neglect all crustal deformation, modeling the bedrock temperature is quite simple.  The equation has only vertical conduction:
  \f[ \rho_b c_b \frac{\partial T}{\partial t} = k_b \frac{\partial^2 T}{\partial z^2}. \f]
Here we assume \f$\rho_b,k_b,c_b\f$ are constant material properties.

Because there is no advection, the simplest centered implicit (backward Euler) scheme is easily "bombproof" without choosing \f$\lambda\f$, or other complications.  It has this scaled form,
\anchor bedrockeqn
\f[ -R_b T_{k-1}^{n+1} + \left(1 + 2 R_b\right) T_k^{n+1} - R_b T_{k+1}^{n+1}
         = T_k^n, \tag{bedrockeqn} \f]
where 
  \f[ R_b = \frac{k_b \Delta t}{\rho_b c_b \Delta z^2}. \f]
This is unconditionally stable for a pure bedrock problem, and has a maximum principle, without any further qualification [\ref MortonMayers].

The geothermal flux \f$G\f$ is applied at the bottom of the bedrock.  The second of equations (\ref columnbcs) is now
        \f[ - k_b \frac{\partial T}{\partial z}\Big|_{z=-Lbz} = G. \f]
Thus we have this approximated Neumann boundary condition at the base of the bedrock:
\anchor geothermalbedeqn
\f[ \left(1 + 2 R_b\right) T_0^{n+1} - 2.0 R_b T_{+1}^{n+1}
         = T_0^n + \frac{2 \Delta t G}{\rho_b c_b \Delta z}. \tag{geothermalbedeqn} \f]
The argument for this equation is standard, involving a temporary value \f$T_{-1}^{n+1}\f$ [\ref MortonMayers].

According to the cases described in the next subsection, the bedrock thermal layer problem is either solved by combinedSystemCtx or bedrockOnlySystemCtx.  In the former case the ice and bedrock are combined together in one large system.  In the latter case the top of the bedrock temperature is a known value (Dirichlet condition).


\section melt Heat flux jump and melt rate at ice base

At the bottom of grounded ice, a certain amount of heat comes out of the earth and either enters the ice through conduction or melts the base of the ice.  If the ice sheet is sliding then additional heat is generated at the contact of the ice and the underlying material.  Because the PISM user may or may not want a bedrock thermal layer, because the basal ice may be cold (below the pressure-melting temperature) or temperate, and because the ice might be grounded or floating, we see there are a number of cases to consider and approximate by finite differences.

Equations (5.40) and (9.134) of \ref GreveBlatter2009, which are identical, give a common framework describing the jump in conductive heat flux in both the cold and temperate cases, however:
\anchor meltheuristic
\f{equation*}
\left(\begin{matrix}\text{conductive heat flux} \\ \text{from bedrock}\end{matrix}\right) - \left(\begin{matrix}\text{conductive heat flux} \\ \text{into the base of the ice}\end{matrix}\right) = \left(\text{heat lost to melt rate}\right) - \left(\text{heat gained from friction}\right)
\f}
In particular, if there is zero basal melt rate and no sliding, so that both terms on the right are zero, then the heat flux is a continuous vector quantity across the ice/bedrock interface.  Otherwise the above equation describes the heat flux jump.

In symbols, let \f$M\f$ be the basal melt rate, positive when ice is being turned into liquid, and \f$L\f$ be the latent heat of fusion of water.  We use a small-slope assumption for the base, namely we assume that the normal direction to the ice base is the \f$z\f$ direction.  Recall that
  \f[ F_b = - \tau_b \cdot \mathbf{u}_b \f]
is the heating rate from friction.  With this notation, the right hand side has the same form for all grounded cases:
\anchor melteqn
\f{align*}
\left(\begin{matrix}\text{conductive heat flux} \\ \text{from bedrock}\end{matrix}\right) - \left(\begin{matrix}\text{conductive heat flux} \\ \text{into the base of the ice}\end{matrix}\right) &= \rho_i L M - F_b
\f}
Zero sliding is, of course, a possible condition for the velocities going into BOMBPROOF.

Though the frictional heating rate from sliding is determined before doing the time step for conservation of energy, the melt rate is \e not known until the conservation of energy boundary value problem is solved.  Thus \f$M\f$ is an unknown below.  Ideally the melt rate produced thermodynamically here would be consistent with the same quantity used as the lower boundary condition determining vertical velocity from incompressibility (see IceModel::vertVelocityFromIncompressibility()) at the same time step.  For now, however, we treat the column ice velocity as known at the beginning of the step, even though it actually came from the calculation of the melt rate at the previous step.  As a consequence, for now we accept an \f$O(\Delta t)\f$ error by not iterating to solve this consistency relation.  In the tables below, \f$w(0^+)\f$ is the vertical ice velocity at the bottom ice grid location, and it came from the previous time step, as the melt/refreeze rate.

The following tables detail the cases.  In the linear systems which we solve at each time step in each column of ice, each of the cases below becomes one or two tridiagonal matrices with diagonal dominance.  Since the size and number (one or two) of such systems varies according to the cases, the code is nontrivial to understand.  In particular, when there is a bedrock thermal layer but the base is cold we solve a single system of size <code>Mz + Mbz -1</code>, while if there is a bedrock layer but the base is melting then we solve two systems, the one in ice of size \c Mz and the one in bedrock of size \c Mbz.  The comments in the table below are intended to illuminate this aspect.

In every case below, \f$T(0^-)\f$ should be understood as the temperature at the top of the bedrock, while \f$E(0^+)\f$ is the enthalpy at the bottom of the ice.  The special normalizing value \f$E_s(0^+)\f$ is the enthalpy value which CTS ice would have at that pressure; see EnthalpyConverter.  In particular, \f$c_i^{-1} E_s(0^+)\f$ is the pressure-melting temperature at the base of the ice.  Recall \f$G\f$ is geothermal flux.

\subsection wbedrockcase case: grounded WITH bedrock thermal layer (Mbz>1)

<table border>
<tr>
    <td width="20%"> <b>condition on ice base</b>  </td>
    <td width="20%"> \b continuum \b equations </td>
    <td> \b comments </td>
</tr>
<tr>
    <td> cold ice base: 
         <p> \f$E(0^+)<E_s(0^+)\f$ </p> </td>
    <td> \f[ \begin{matrix}
         T(0^-) = c_i^{-1} E(0^+) \\ \\
         -k_b \frac{\partial T}{\partial z}\Big|_{z=0^-} + k_i c_i^{-1}\frac{\partial E}{\partial z}\Big|_{z=0^+} = 0 - F_b
         \end{matrix} \f] </td>
    <td> <p> The first equation, continuity of temperature, allows the second equation to be written with just three unknowns, E[1], E[0], and Tb[Mbz-2].  The system to solve is then tridiagonal and has unknowns Tb[0] .. Tb[Mbz-2] E[0] .. E[Mz-1] and size Mz + Mbz -1.  The second equation at left thus appears somewhere in the middle of a "large" system for the whole ice and bedrock column.</p>
         <p>The top-of-bedrock temperature Tb[Mbz-1] is \e not one of the unknowns in the system, but is post-computed by the first equation.  </p>
         <p>If the ice is floating then we are not in this case.</p></td>
</tr> 
<tr>
    <td> temperate ice base with downward column velocity:  
         <p>  \f$E(0^+) \ge E_s(0^+)\f$ and \f$ w(0^+) < 0\f$</p> 
    </td>
    <td> \f[ \begin{matrix}
         \frac{\partial E}{\partial t}\Big|_{z=0^+} + w(0^+)\frac{\partial E}{\partial z}\Big|_{z=0^+} = 0 \\ \\
         T(0^-) = c_i^{-1} E_s(0^+)  \\ \\
         -k_b \frac{\partial T}{\partial z}\Big|_{z=0^-} - 0 = \rho_i L M - F_b
         \end{matrix} \f] </td>
    <td> <p> The first equation is no boundary condition at all because, in this case of temperate ice base, we assume zero enthalpy conductivity, so the problem is hyperbolic in the ice.  We upwind implicitly so the discretized form looks like
    \f[ (1-\nu w(0^+)) E_0^{n+1} + \nu w(0^+) E_1^{n+1} = E_0^n, \f]
where \f$\nu=\Delta t/\Delta z\f$ and \f$E_0^{n+1} = \f$E[0] and \f$E_1^{n+1}=\f$E[1], so we believe we have a well-posed ice enthalpy problem.  It is a diagonally-dominant tridiagonal system with unknowns E[0] .. E[Mz-1] and size Mz.  </p>
         <p>The second equation implies that the bedrock thermal problem is well-posed by itself, with Dirichlet condition at the top and Neumann at the bottom.  So we solve it in a system of size Mbz for unknowns Tb[0] .. Tb[Mbz-1].  From the solution Tb[] we compute heat flux out of the top of the bedrock layer, and the third equation gives us the basal melt rate \f$M\f$.  </p>
         <p>If the ice is floating then the second equation is replaced by \f$T(0^-) = T_{sb}\f$, but this is still a Dirichlet condition for the temperature in the bedrock.  The third equation is short-circuited: we get the basal melt rate \f$M\f$ as supplied by by PISMOceanModel::shelf_base_mass_flux().</p>  </td>
</tr> 
<tr>
    <td> temperate ice base with upward column velocity:  
         <p>  \f$E(0^+) \ge E_s(0^+)\f$ and \f$ w(0^+) \ge 0\f$</p>
    </td>
    <td> \f[ \begin{matrix}
         E\Big|_{z=0^+} = E_s(0^+) \\ \\
         T(0^-) = c_i^{-1} E_s(0^+)  \\ \\
         -k_b \frac{\partial T}{\partial z}\Big|_{z=0^-} - 0 = \rho_i L M - F_b
         \end{matrix} \f] </td>
    <td> <p> The first equation is a Dirichlet condition for the ice enthalpy problem.  We are assuming here that any ice advected upward into the ice column "comes in" as pressure-melting temperature ice with zero liquid fraction, if the ice base was temperate at the last time step.  Note that this case occurs if either there was exactly no melt in the previous time step, or if there was refreeze in the previous time step.  The result is a tridiagonal system with unknowns E[0] .. E[Mz-1] and size Mz.  </p>
         <p>The second and third equations have the same interpretation as the case immediately above.  </p> 
         <p>If the ice is floating then the same comments as the in the case immediately above, about the second and third equations, apply.</p></td>
</tr> 
</table>


\subsection nobedrockcase case: grounded with NO bedrock thermal layer (Mbz=1)

<table border>
<tr>
    <td width="20%"> <b>condition on ice base</b>  </td>
    <td width="20%"> \b continuum \b equations </td>
    <td> \b comments </td>
</tr>
<tr>
    <td> cold ice base: 
         <p> \f$E(0^+)<E_s(0^+)\f$ </p> </td>
    <td> \f[ \begin{matrix}
         T(0^-) = c_i^{-1} E(0^+) \\ \\
         G + k_i c_i^{-1}\frac{\partial E}{\partial z}\Big|_{z=0^+} = 0 - F_b
         \end{matrix} \f] </td>
    <td> <p> The second equation is a Neumann condition for the enthalpy problem.  Thus the system has unknowns E[0] .. E[Mz-1] and size Mz.  The first equation then computes Tb[0]. </p>
         <p>If the ice is floating then we are not in this case.</p></td>
</tr> 
<tr>
    <td> temperate ice base with downward column velocity:  
         <p>  \f$E(0^+) \ge E_s(0^+)\f$ and \f$ w(0^+) < 0\f$</p>
    </td>
    <td> \f[ \begin{matrix}
         \frac{\partial E}{\partial t}\Big|_{z=0^+} + w(0^+)\frac{\partial E}{\partial z}\Big|_{z=0^+} = 0 \\ \\
         T(0^-) = c_i^{-1} E_s(0^+)  \\ \\
         G - 0 = \rho_i L M - F_b
         \end{matrix} \f] </td>
    <td> <p> The first equation has exactly the same interpretation as in the corresponding with-bedrock case above. </p>
    <p> The temperature Tb[0] at the top of the bedrock is computed by the second equation.  The melt rate \f$M\f$ can be set immediately from the third equation. </p> 
    <p>If the ice is floating then the second equation is replaced by \f$T(0^-) = T_{sb}\f$, directly giving Tb[0].  The third equation is short-circuited: we get the basal melt rate \f$M\f$ as supplied by by PISMOceanModel::shelf_base_mass_flux().</p></td>
</tr> 
<tr>
    <td> temperate ice base with upward column velocity:  
         <p>  \f$E(0^+) \ge E_s(0^+)\f$ and \f$ w(0^+) \ge 0\f$</p>
    </td>
    <td> \f[ \begin{matrix}
         E\Big|_{z=0^+} = E_s(0^+) \\ \\
         T(0^-) = c_i^{-1} E_s(0^+)  \\ \\
         G - 0 = \rho_i L M - F_b
         \end{matrix} \f] </td>
    <td> <p> The first equation  has exactly the same interpretation as in the corresponding with-bedrock case above. </p>
         <p>The second and third equations have the same interpretation as the case immediately above.  </p> 
         <p>If the ice is floating then the same comments as the in the case immediately above, about the second and third equations, apply.</p></td>
</tr> 
</table>



Regarding the floating case:  The shelf base temperature \f$T_{sb}\f$ is supplied by PISMOceanModel::shelf_base_temperature().  The melt rate \f$M\f$ is supplied as a boundary condition from the ocean model by PISMOceanModel::shelf_base_mass_flux().  Note the odd physical choice that the shelf base temperature is used as the temperature at the \e top of the \e bedrock, which is actually the bottom of the ocean.  This choice means that the conservation of energy code does not need to know about the bedrock topography or the elevation of sea level.  FIXME: But there could be a PISMOceanModel::subshelf_bed_temperature() routine.




*/  /* <--- IF END-OF-COMMENT LOST, CONFUSION RESULTS ... */

