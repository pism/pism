\documentclass[titlepage,letterpaper,final]{scrartcl}

\usepackage{scrindex}           % multiple index support using the "index" package
\usepackage{index}

%% THE FOLLOWING SHOULD CHANGE FOR A STABLE RELEASE:
\newcommand{\PISMREV}{revision \input{revision.tex}}
\newcommand{\PETSCREL}{3.2}
\newcommand{\PISMDOWNLOADMSG}{Get development branch source code: \quad\texttt{git clone -b dev git@github.com:pism/pism.git pism-dev} \quad}
\newcommand{\PISMBROWSERURL}{http://www.pism-docs.org/wiki/doku.php?id=browser}

\addtolength\textheight{0.75in}
\addtolength{\oddsidemargin}{-.4in}
\addtolength{\evensidemargin}{-.4in}
\addtolength{\textwidth}{0.9in}
\newcommand{\normalspacing}{\renewcommand{\baselinestretch}{1.1}\tiny\normalsize}
\newcommand{\tablespacing}{\renewcommand{\baselinestretch}{1.0}\tiny\normalsize}
\normalspacing

\usepackage[usenames]{xcolor}

\usepackage{bm,url,xspace,verbatim}
\usepackage{amssymb,amsmath}
\usepackage[pdftex]{graphicx}
\usepackage{booktabs}           % better rules in tables
\usepackage{xtab}               % long (multi-page) tables

%% uncomment to see locations of index entries
% \proofmodetrue

\usepackage[nohyphen]{underscore}

% this lets us avoid the scrartcl/hyperref conflict...
\let\ifvtex\relax

\usepackage{xr}
\externaldocument[userman-]{../userman/manual}

% hyperref should be the last package we load
\usepackage[pdftex,
colorlinks=true,
plainpages=false, % only if colorlinks=true
linkcolor=blue,   % only if colorlinks=true
citecolor=blue,   % only if colorlinks=true
urlcolor=blue     % only if colorlinks=true
]{hyperref}

\newcommand{\ddt}[1]{\ensuremath{\frac{\partial #1}{\partial t}}}
\newcommand{\ddx}[1]{\ensuremath{\frac{\partial #1}{\partial x}}}
\newcommand{\ddy}[1]{\ensuremath{\frac{\partial #1}{\partial y}}}
\renewcommand{\t}[1]{\texttt{#1}}
\newcommand{\Matlab}{\textsc{Matlab}\xspace}
\newcommand{\bq}{\mathbf{q}}
\newcommand{\bU}{\mathbf{U}}
\newcommand{\eps}{\epsilon}
\newcommand{\grad}{\nabla}
\newcommand{\Div}{\nabla\cdot}

%% macros having to do with documentation for options; note these appear in the index

\newindex{default}{idx}{ind}{General Index}
\newindex{options}{odx}{ond}{Command-line options}

\def\optsection#1{%
  \def\optindex##1{\index[options]{#1!##1}}
  \def\optseealso##1{\index[options]{#1|see{##1}}}
}

\optsection{FIXME}

% Use this to index option definitions:
\newcommand{\intextoption}[1]{\texttt{-#1}\optindex{\texttt{-#1}}}

\newcommand{\txtopt}[2]{\texttt{-#1} #2\optindex{\texttt{-#1} #2}}

\newcommand{\listopt}[1]{\txtopt{#1}{\emph{comma-separated list}}}
\newcommand{\fileopt}[1]{\txtopt{#1}{\emph{filename}}}
\newcommand{\timeopt}[1]{\txtopt{#1}{\emph{range or list}}}


\pdfinfo{
  /Title (PISM climate forcing components)
  /Author (the PISM authors)
  /Subject (Setting up PISM's climate forcing)
  /Keywords (PISM ice sheet modeling climate forcing)
}

\begin{document}

\begin{titlepage}

  \begin{center}
    \vspace*{3.5cm}
    {\huge\usekomafont{title} PISM's climate forcing components}
    \vspace{0.5cm}

    {\Large The PISM Authors}
    \vspace{1cm}

    \vfill

    \small Support by email: \texttt{help\@@pism-docs.org}.
    \medskip

    Manual date \today. Based on PISM \PISMREV.
    \medskip

    \PISMDOWNLOADMSG
  \end{center}
\end{titlepage}

\newpage
\phantom{bob}

\begin{center}
  Please see the \emph{PISM User's Manual} for the list of authors
\end{center}

\vspace{0.2in}
\begin{quote}
  \textsl{Copyright (C) 2004--2012 The PISM Authors}
  \medskip

  \noindent \textsl{This file is part of PISM.  PISM is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  PISM is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License\index{GPL (\emph{GNU Public License})} along with PISM; see \emph{\texttt{COPYING}}.  If not, write to the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA}
\end{quote}

\newpage
\setcounter{tocdepth}{3}
\small
\tableofcontents
\normalsize

\newpage


\section{Introduction}
\label{sect:intro}

Please see section \ref*{userman-sec:climate-inputs} of the User's Manual for
an overview of PISM's climate forcing interfaces.

Setting up PISM's boundary models requires selecting one \emph{surface} and one
\emph{ocean} model, and possibly one \emph{atmosphere} model--- depending on
the surface model choice.

Command-line options \texttt{-atmosphere}, \texttt{-surface} and
\texttt{-ocean} each take a comma-separated list of keywords as an argument;
the first keyword \emph{has} to correspond to a model, the rest can be
modifiers. Any of these options can be omitted to use the default atmosphere,
surface or ocean model, although one has to choose a model to use a modifier.

Selected models and modifiers are chained as in
Figure~\ref*{userman-fig:climate-input-data-flow} of the User's Manual.

Please see section \ref{sec:known-use-cases} for examples.

\section{Managing model time}
\label{sec:model-time}
\optsection{Managing model time}

Most of PISM only needs to know how long the current time step is. The climate
forcing code, on the other hand, uses time to provide boundary conditions to
other components.

This section describes how to control model time to ensure that the February
mass balance is used for 28 and not $365/12 = 30.4167$ days--- and related
issues.

\subsection{Periodic climate data}
\label{sec:periodic-forcing}

All components reading time-dependent forcing data from files can interpret
this data as ``periodic''. Each component has a unique command-line option
prefix. Please refer to corresponding sections for values of the prefix.

The length of the period (in years) is specified using \texttt{-prefix_period}
option.

For example, to prescribe constant (from year to year) climate which includes
inter-annual variations using the \texttt{-surface given} option, set:
\begin{verbatim}
-surface given -surface_given_period 1 -surface_given_file forcing.nc
\end{verbatim}

If forcing data has the period other than one year it is also
necessary to specify the ``starting time'' using the
\texttt{-prefix_reference_year} option.

For example, to use a 20 year long climate record as periodic climate starting
at the beginning of the model year 10, do
\begin{verbatim}
-surface given -surface_given_period 20 -surface_given_file forcing.nc \
-surface_given_reference_year 10
\end{verbatim}

Note that the reference year is given in \emph{model years}, not calendar
years. We find that it is usually possible to avoid confusion by starting runs
corresponding to specific historical periods at year zero and using the
\texttt{-reference_date} option to tie the run to a particular date. For instance,
\begin{verbatim}
-surface given -surface_given_period 20 -surface_given_file forcing.nc \
-ys 0 -reference_date 1989-1-1
\end{verbatim}
will use climate data as periodic with the period of 20 years starting on
January 1, 1989. Please see section \ref{sec:calendars} for more details.

The \texttt{time} variable in a forcing file that is to be used as periodic
should start at $0$.

\subsection{Using time bounds in forcing data}
\label{sec:time-bounds}

PISM interprets climate  forcing data as piecewise-constant in  time. A forcing
file can specify the time bounds  corresponding to each record by following the
CF (Climate and Forecasting) meta-data conventions.

The \texttt{ncdump -h} output from a conforming file would look similar to the
following:
\begin{verbatim}
netcdf forcing {
dimensions:
        time = UNLIMITED ; // (214 currently)
        nv = 2 ;
variables:
        double time(time) ;
                time:units = "seconds since 2000-1-1" ;
                time:axis = "T" ;
                time:bounds = "time_bounds" ;
                time:calendar = "gregorian" ;
                time:long_name = "time" ;
        double nv(nv) ;
        double time_bounds(time, nv) ;
\end{verbatim}

The \texttt{time_bounds} variable stores the starting and the ending time for
each interval in the forcing. This variable is assumed to have the same units
as the \texttt{time} variable it is associated with, which is why its arguments
are not set in this example.

\subsection{Calendars}
\label{sec:calendars}

Internally PISM stores time in ``seconds since a specified moment'' and
does not use or need a calendar.

However, XX-century and prognostic runs require knowledge of lengths of months
and years, both to use climate data properly and to facilitate model validation
using observations.

The next two sections describe modes of time management implemented in PISM.

\subsubsection{\texttt{365_day} calendar}
\label{sec:365-day}

The default \txtopt{calendar}{\texttt{365_day}} option is used in all PISM
runs that do not require precise application of forcing data or reporting on
particular dates.

In this mode PISM \emph{ignores} the reference date in time unit specifications
(such as ``\texttt{days since 1969-7-20}''). The value set using
\texttt{reference_date} option or the configuration parameter is saved in
output files, though.

\subsubsection{\texttt{gregorian} calendar}
\label{sec:gregorian}

The command-line option \txtopt{calendar}{\texttt{gregorian}} enables the Gregorian
calendar mode.

The implications are:
\begin{itemize}
\item PISM uses the date in\texttt{units} attributes of coordinate variables in
  unit conversions. Please make sure that the \texttt{time} variable in all
  forcing files has the units attribute such as ``\texttt{days since
    2012-1-1}''. PISM will stop with an error message if a time variable does
  not have a reference date in its unit specification.

\item It is important to use units that are a fixed multiple of ``seconds'',
  such as ``\texttt{minutes since 1989-1-1}'' or ``\texttt{days since
    1999-12-31}'' and avoid ``months'' and ``years''. (PISM uses UDUNITS to
  convert units, and in UDUNITS one month is always interpreted as
  $\frac{1}{12}\cdot 365.2524$ days.)
\item PISM uses dates in standard output:
\begin{verbatim}
...
   time interval (length)   [2012-01-01, 2021-12-31]  (10.000 years)
...
S 2012-05-26:  0.00011    0.6306   0.00000000           0.00000
$v$Eh m (dt=0.10000)
S 2012-07-01:  0.00014    0.6306   0.00000000           0.00000
\end{verbatim}
\end{itemize}

Just like in the \texttt{365_day} mode, run length, run start and run end times
are specified using \intextoption{y}, \intextoption{ys} and \intextoption{ye}
command-line options, respectively. Note that here \texttt{-y 1} has the
meaning of $3.14...\cdot 10^{7}$ seconds (one ``tropical year''), \emph{not} a
calendar year.

To specify the reference date, i.e. the date corresponding to time $0$, use the
\txtopt{reference_date}{\texttt{YYYY-MM-DD}} command-line option or the
\texttt{reference_date} configuration parameter.

For example, to run for $20$ years starting in $1989$ and override time read
from an input file, do
\begin{verbatim}
$ pismr -calendar gregorian -reference_date 1989-1-1 -ys 0 -ye 20
\end{verbatim}

It is also possible to run PISM for the duration of the available forcing data using the \fileopt{time_file} option.
This command
\begin{verbatim}
$ pismr -calendar gregorian -time_file forcing.nc
\end{verbatim}
will extract the reference date and run length from \texttt{forcing.nc} (respecting time bounds).

It is also possible to save spatial and/or scalar time-series daily, monthly or
yearly (using the Gregorian calendar). See sections \ref*{userman-sec:saving-time-series}
and \ref*{userman-sec:saving-spat-vari} of the User's Manual.

\section{Known use cases (and corresponding options)}
\label{sec:known-use-cases}

This section gives a very brief overview of some coupling options. Please see sections referenced below for more information.

\subsection{One way coupling to a climate model}
\label{sec:one-way-coupling}

This is the simplest (and preferred) case.

\subsubsection{Ice surface temperature and mass balance}
\label{sec:ice-surface-bc}
\begin{center}
  \begin{tabular}{lp{0.7\textwidth}}
    \toprule
    Variable names: & \texttt{acab}, \texttt{artm} \\
    Options: & \texttt{-surface given -surface_given_file forcing.nc} \\
    Software components: & \texttt{PSGivenClimate} \\
    See also & section \ref{sec:surface-given} \\
    \bottomrule
  \end{tabular}
\end{center}

\subsubsection{Air temperature and precipitation}
\label{sec:air-temp-and-precip}

If  a climate model  provides near-surface  air temperature  and precipitation,
these  data need  to be  converted into  top of  the ice  temperature  and mass
balance.

PISM has  a temperature index  (PDD) model with adjustable  parameters. Default
parameter values come from \cite{RitzEISMINT}.

\begin{center}
  \begin{tabular}{lp{0.7\textwidth}}
    \toprule
    Variable names: & \texttt{precip}, \texttt{air_temp} \\
    Options: & \texttt{-atmosphere given -atmosphere_given_file forcing.nc -surface~pdd} \\
    Software components: & \texttt{PAGivenClimate}, \texttt{PSTemperatureIndex} \\
    See also & \texttt{-atmosphere given} : \ref{sec:atmosphere-given},
    \texttt{-surface pdd}: \ref{sec:surface-pdd} \\
    \bottomrule
  \end{tabular}
\end{center}

I a case when melt is  negligible \texttt{-surface pdd} should be replaced with
\texttt{-surface simple}.

\subsection{SeaRISE-Greenland}
\label{sec:use-case-searise-greenland}

The SeaRISE-Greenland setup uses the parameterized near-surface air temperature
\cite{Faustoetal2009} and a precipitation field read from an input (\texttt{-i}
or \texttt{-boot_file}) file, plus  a temperature-index (PDD) scheme to compute
the surface mass balance.

\begin{center}
  \begin{tabular}{lp{0.7\textwidth}}
    \toprule
    Variable names: & \texttt{precip} \\
    Options: & \texttt{-atmosphere searise_greenland -surface~pdd} \\
    Software components: & \texttt{PASeariseGreenland}, \texttt{PSTemperatureIndex} \\
    See also & \texttt{-atmosphere searise_greenland} : \ref{sec:atmosphere-searise-greenland},
    \texttt{-surface pdd}: \ref{sec:surface-pdd} \\
    \bottomrule
  \end{tabular}
\end{center}

\subsection{SeaRISE-Greenland paleo-climate run}
\label{sec:use-case-searise-greenland-paleo}

The air temperature parameterization in the previous section is appropriate for
present  day  modeling. PISM  includes  some  corrections  taking into  account
differences  between present  and past  climates.  In particular,  one can  use
ice-core  derived   scalar  air  temperature   offsets  \cite{JohnsenetalGRIP},
precipitation  adjustments  \cite{Huybrechts02},  and  sea level  offsets  from
SPECMAP \cite{Imbrieetal1984}.

\begin{center}
  \begin{tabular}{lp{0.7\textwidth}}
    \toprule
    Variable names: & \texttt{precip}, \texttt{delta_T}, \texttt{delta_SL}\\
    Options: & \texttt{-atmosphere searise_greenland,dTforcing
      \mbox{-dTforcing delta_T.nc}
      -paleo_precip  -surface pdd \mbox{-ocean constant,dSLforcing}
      -dSLforcing delta_SL.nc} \\
    Software components: & \texttt{PASeariseGreenland}, \texttt{PSTemperatureIndex} \\
    See also & \texttt{-atmosphere searise_greenland} : \ref{sec:atmosphere-searise-greenland},
    \texttt{-surface pdd}: \ref{sec:surface-pdd} \\
    \bottomrule
  \end{tabular}
\end{center}

Note that the temperature offsets are applied to \emph{air} temperatures at the
\emph{atmosphere level}. This ensures that $\Delta T$ influences the PDD
computation.

\subsection{Using climate anomalies}
\label{sec:use-case-climate-anomalies}

Prognostic modeling experiments frequently use time- and space-dependent
air temperature and precipitation anomalies.

\begin{center}
  \begin{tabular}{lp{0.7\textwidth}}
    \toprule
    Variable names: & \\
    Options:  &  \texttt{-atmosphere given,anomaly  -atmosphere_anomaly_file
      anomalies.nc -surface simple} \\
    Software components: & \texttt{PAGivenClimate}, \texttt{PAAnomaly}, \texttt{PSSimple}\\
    See  also   &  \texttt{-atmosphere  given}   :  \ref{sec:atmosphere-given},
    \texttt{anomaly}: \ref{sec:atmosphere-anomaly}, \texttt{-surface simple}: \ref{sec:surface-simple}\\
    \bottomrule
  \end{tabular}
\end{center}

The \texttt{simple} surface model re-interprets precipitation as mass balance, which is useful in cases when there is no melt (Antarctic simulations is an example).

Simulations of the Greenland typically replace \texttt{-surface~simple} with \texttt{surface~pdd}.

\subsection{Antarctic paleo-climate runs}
\label{sec:use-case-antarctica-paleo}

\begin{center}
  \begin{tabular}{lp{0.7\textwidth}}
    \toprule
    Variable names: & \texttt{acab}, \texttt{artm}, \texttt{delta_T}, \texttt{delta_SL}\\
    Options: & \texttt{-surface given,dTforcing \mbox{-dTforcing delta_T.nc}
      \mbox{-ocean constant,dSLforcing} -dSLforcing delta_SL.nc} \\
    Software   components:  &   \texttt{PSGivenClimate},  \texttt{PSdTforcing},
    \texttt{POConstant}, \texttt{POdSLforcing}\\
    See   also    &   \texttt{-surface~given}    :   \ref{sec:surface-given},
    \texttt{dTforcing}: \ref{sec:surface-delta-temp}\\
    \bottomrule
  \end{tabular}
\end{center}

\section{Checking if forcing data is used correctly}
\label{sec:checking-forcing}


\subsection{Visualizing climate inputs, without ice dynamics}
\label{sec:pclimate}
\optsection{\texttt{pclimate} options}

Recall that internally in PISM there is a separation of climate inputs from ice
dynamics (see User's Manual, section \ref*{userman-sec:climate-inputs}). Executable
\texttt{pclimate} \index{executables!\texttt{pclimate}} allows one to visualize climate inputs without
invoking the ice dynamics core of PISM. This is helpful during the process of
creating PISM-readable data files, and modeling with such.

\texttt{pclimate} shares the code implementing climate models with other PISM
executables, so everything said elsewhere in this document  applies
here. In addition to \texttt{-atmosphere}, \texttt{-surface}, \texttt{-ocean}
and others, \texttt{pclimate} takes options listed in table \ref{tab:pclimate}.

\begin{table}[ht]
  \centering
  \caption{\texttt{pclimate} command-line options}
  \begin{tabular}{p{0.25\linewidth}p{0.7\linewidth}}\toprule
    \textbf{Option} & \textbf{Description}\\
    \midrule
    \fileopt{i} & specifies an input file, which has been produced by PISM;\\
    \fileopt{o} & sets the output file name;\\
    \txtopt{ys}{(years)} & sets the start time, in years;\\
    \txtopt{ye}{(years)} & sets the final time, in years;\\
    \txtopt{dt}{(years)} & sets the interval between saved climate snapshots.\\
    \bottomrule
 \end{tabular}
 \label{tab:pclimate}
\end{table}

\bigskip
As an example, set up an ice sheet state file and run \texttt{pclimate} on it:
\begin{verbatim}
$ mpiexec -n 2 pisms -eisII A -y 1000 -o state.nc
$ pclimate -i state.nc -surface constant -ys 0.0 -ye 2.5 -dt 0.1 -o movie.nc
\end{verbatim}
Using \texttt{pisms} merely generates demonstration climate data, using
EISMINT II choices \cite{EISMINT00}.  \texttt{pclimate} extracts the 
surface mass balance \texttt{acab} and surface temperature \texttt{artm} from \texttt{state.nc}.
It then does nothing interesting, exactly because a constant climate
is used.  Viewing \texttt{movie.nc} we see these same values as from \texttt{state.nc},
in variables \texttt{acab}, \texttt{artm}, reported back to us as the time- and space-dependent
climate at times \texttt{ys:dt:ye}.  It is a boring ``movie.''

The excuse for the executable \texttt{pclimate} becomes clearer if we use a positive degree-day
model (section \ref{sec:surface-pdd}).  The positive degree-day
model uses a variable called \texttt{precip}, and a calculation of melting, to get the
surface mass balance \texttt{acab}.

Assuming that \texttt{g20km_pre100.nc} was created as described in the User's Manual, section \ref*{userman-sect:start}, running
\begin{verbatim}
$ pclimate -i g20km_pre100.nc -atmosphere searise_greenland \
           -surface pdd -ys 0 -ye 2.5 -dt 0.1 -o foo.nc
\end{verbatim}%$
produces \texttt{foo.nc}. Viewing in with \texttt{ncview} shows an annual cycle in the variable \texttt{airtemp} and a noticeable decrease in the surface mass balance during summer months (see variable \texttt{acab}). Note that \texttt{artm} is constant in time: this is the temperature \emph{at the ice surface but below firn} and it does not include seasonal variations \cite{Hock05}.

See User's Manual, section \ref*{userman-sec:eismint-greenland}, for another \texttt{pclimate} example.

\subsection{Low-resolution test runs}
\label{sec:low-resolution-test-runs}

\newcommand{\surface}{Surface models (\texttt{-surface})}

\section{Surface mass and energy process models}
\label{sec:surface}

\subsection{The ``invisible'' model}
\label{sec:surface-simple}
\index[options]{\surface!\texttt{simple}}

The simplest ``surface model'' available in PISM, enabled using \texttt{-surface simple}. Its job is to re-interpret precipitation as surface mass flux (balance), and to re-interprets mean annual near-surface (2m) air temperature as the temperature of the ice at the depth at which firn processes cease to change the temperature of the ice.  (I.e.~the temperature \emph{below} the firn.) This implies that there is no melt. Though primitive, this model may be desired in cold environments (e.g.~East Antarctic ice sheet) in which melt is negligible and heat from firn processes is ignored.

\subsection{Reading top-surface boundary conditions from a file}
\label{sec:surface-given}
\optsection{\surface!\texttt{given}}

This surface model reads constant in time ice upper surface boundary conditions from a file. These fields are provided directly to the ice dynamics model (see User's Manual, table \ref*{userman-tab:ice-dynamics-bc}). Variables \texttt{artm} (ice temperature at the ice surface but below firn) and \texttt{acab} (top surface mass flux into the ice) are read from the file, so this choice will cause PISM to stop if they are not present in the input file.

Note: this surface model \emph{ignores} the atmosphere model selection made using the \texttt{-atmosphere} option.

(\texttt{given})

This surface model is similar to \texttt{constant} in that it uses \texttt{artm} and \texttt{acab} fields given by the user by providing them directly to the ice dynamics model. The name of the file PISM will read \texttt{artm} and \texttt{acab} from is specified using the \fileopt{surface_given_file} option.

A file \texttt{foo.nc} used with \texttt{-surface given -surface_given_file foo.nc} should contain several records;\footnote{If this file contains one record (i.e. fields corresponding to one time value only), \texttt{-surface given} is essentially equivalent to \texttt{-surface constant}.} the time variable (\texttt{'t'}) should describe what model time these records correspond to.

This model was created to force PISM with sampled (possibly periodic) climate data, e.g. using monthly records of \texttt{artm} and \texttt{acab}.

Option \txtopt{surface_given_period}{years} makes PISM interpret data in \texttt{-surface_given_file} as periodic. In this case the time in the NetCDF file is understood as the time \emph{from the beginning of a period}, i.e. from the beginning of a year with \texttt{-surface_given_period 1}, from the beginning of a decade with \texttt{-surface_given_period 10}, etc.

For example, to use monthly records and period of 1 year, create a file (say, ``\texttt{foo.nc}'') with 12 records. The variable \texttt{'t'} should contain 0, 1, 2, 3, \dots, 11 and have the units of ``month'' (you can use other units, too). Then, run
\begin{verbatim}
$ pimsr -surface given -surface_given_file foo.nc -surface_given_period 1
\end{verbatim}%$

To force PISM using monthly records with longer periods, just add more records to the \texttt{-surface_given_file}  and change the \texttt{-surface_given_period} value.

\noindent Notes:
\begin{itemize}
\item PISM can handle files with virtually any number of records: it will
  read and store in memory at most \texttt{climate_forcing_buffer_size} records
  at any given time (default: 60, or 5 years' worth of monthly fields).
\item this surface model \emph{ignores} the atmosphere model selection made
  using the \texttt{-atmosphere} option,
\item when preparing a file for use with this model, it is best to use the \texttt{t,x,y} variable storage order: files using this order can be read in faster than ones using the \texttt{t,y,x} order, for reasons explained in the User's Manual, section \ref*{userman-sec:pism-io-performance}.

  To change the storage order in a NetCDF file, use \texttt{ncpdq}:
\begin{verbatim}
$ ncpdq -a t,x,y input.nc output.nc
\end{verbatim}%$
  will copy data from \texttt{input.nc} into \texttt{output.nc}, changing the storage order to \texttt{t,x,y} at the same time.
\end{itemize}

\subsection{Elevation-dependent temperature and mass balance}
\label{sec:surface-elev-depend-temp}
\optsection{\surface!\texttt{elevation}}

\newcommand{\var}[2]{ {#1}_{\text{#2}} }
\newcommand{\h}[1]{ \var{h}{#1} }
\newcommand{\T}[1]{ \var{T}{#1} }
\newcommand{\m}[1]{ \var{m}{#1} }
\newcommand{\ms}[1]{ \var{m^{*}}{#1} }
\newcommand{\diff}[2]{ \frac{\mathrm{d}#1}{\mathrm{d}#2} }

This surface model parameterizes the ice surface temperature $T_{h}$ = \texttt{artm} and the surface mass balance $m$ = \texttt{acab} as \emph{piecewise-linear} functions of surface elevation $h$.

The option \txtopt{artm}{\emph{list of 4 numbers}} determines the surface temperature using the 4 parameters $\T{min}$, $\T{max}$, $\h{min}$, $\h{max}$. Let
\begin{equation}
  \diff{T}{h} = (\T{max} - \T{min}) / (\h{max} - \h{min})
\end{equation}
be the temperature gradient. Then
\begin{equation}
  T(x,y) =
  \begin{cases}
    \T{min}, & h(x,y) \le \h{min}, \\
    \T{min} + \diff{T}{h} \, (h(x,y) - \h{min}), & \h{min} < h(x,y) < \h{max}, \\
    \T{max}, & \h{max} \le h(x,y).
  \end{cases}
\end{equation}

The option \txtopt{acab}{\emph{list of 5 numbers}} determines the surface mass balance using the 5 parameters $\m{min}$, $\m{max}$, $\h{min}$, $\h{ELA}$, $\h{max}$. Let
\begin{equation}
  \diff{\m{abl}}{h} = -\m{min} / (\h{max} - \h{min})
\end{equation}
and
\begin{equation}
\diff{\m{acl}}{h} = \m{max} / (\h{max} - \h{min})
\end{equation}
be the mass balance gradient in the ablation and in the accumulation area, respectively.  Then
\begin{equation}
  m(x,y) =
  \begin{cases}
   \m{min}, & h(x,y) \le \h{min}, \\
   \diff{\m{abl}}{h} \, (h(x,y) - h_{\text{ELA}}), &  \h{min} < h(x,y) < \h{max}, \\
   \diff{\m{acl}}{h} \, (h(x,y) - h_{\text{ELA}}), & \h{min} < h(x,y) < \h{max}, \\
   \m{max}, & \h{max} \le h(x,y).
 \end{cases}
\end{equation}

The option \txtopt{acab_limits}{\emph{list of 2 numbers}} limits the mass balance below $\h{min}$ to $\ms{min}$ and above $\h{max}$ to $\ms{max}$, thus
\begin{equation}
  m(x,y) =
  \begin{cases}
    m^{*}_{\text{min}}, & h(x,y) \le \h{min}, \\
    \diff{\m{abl}}{h} \, (h(x,y) - h_{\text{ELA}}), & \h{min} < h(x,y) < \h{max}, \\
    \diff{\m{acl}}{h} \, (h(x,y) - h_{\text{ELA}}), & \h{min} < h(x,y) < \h{max}, \\
    m^{*}_{\text{max}}, & \h{max} \le h(x,y).
  \end{cases}
\end{equation}

Note: this surface model \emph{ignores} the atmosphere model selection made using the \texttt{-atmosphere} option.

\subsection{Temperature-index (positive degree-day) scheme}
\label{sec:surface-pdd}
\optsection{\surface|\texttt{pdd}}

(\texttt{pdd}) \index{temperature-index surface processes model} \index{positive degree day surface processes model} \index{PDD (positive degree day model)} \index{PISM!default positive degree day model} 

The default PDD used by PISM, turned on by option \texttt{-surface pdd}, is based on \cite{CalovGreve05} and EISMINT-Greenland intercomparison (see User's Manual, section \ref*{userman-sec:eismint-greenland}, and \cite{RitzEISMINT}).

Our PDD implementation is meant to be used with an atmosphere model implementing a cosine yearly cycle such as \texttt{searise_greenland} and \texttt{eismint_greenland}, but is not restricted to parameterizations like this one. A PDD generally adds ``white noise'' to the seasonal cycle to simulate additional daily variability associated to the vagaries of weather.  This additional random variation is quite significant, as the seasonal cycle may never reach the melting point but that point may be reached with some probability, in the presence of the daily variability, and thus melt may occur.  Concretely, a normally-distributed, mean zero random temperature increment is added to the seasonal cycle. There is no assumed spatial correlation of daily variability. The standard deviation of the daily variability is controlled by the \intextoption{pdd_std_dev} option, and the corresponding configuration parameter has the same name. The default value is 5.0 degrees \cite{RitzEISMINT}.

The number of positive degree days is computed as the magnitude of the temperature excursion above $0\!\phantom{|}^\circ \text{C}$ multiplied by the duration (in days) when it is above zero. In PISM there are actually two methods for computing the number of positive degree days. The first computes only the expected value, by the method described in \cite{CalovGreve05}. This is the default when a PDD is chosen (i.e.~option \texttt{-surface pdd}). The second is a monte carlo simulation of the white noise itself, chosen by adding the option \intextoption{pdd_rand}. This monte carlo simulation adds the same daily variation at every point, though the seasonal cycle is (generally) location dependent. If repeatable randomness is desired use \intextoption{pdd_rand_repeatable} instead of \texttt{-pdd_rand}.

The number of positive degree days is multiplied by a coefficient (config parameter \texttt{pdd_factor_snow}) to compute the amount of snow melted. Of the melted snow, a fraction (\texttt{pdd_refreeze}) is kept as ice. This ice, plus all unmelted snow (already measured as ice-equivalent) is added to the mass balance, unless the number of positive degree days exceeds that required to melt all of the snow. In this latter case, in which there are excess positive degree days available for melting, the excess is multiplied by a coefficient (\texttt{pdd_factor_ice}) to compute how much ice is melted. In this case actual ablation occurs at that location.

In addition to this, one may use latitude- and July-air-temperature-dependent Greenland PDD model parameters $\beta_{\mathrm{ice}}$ and $\beta_{\mathrm{snow}}$ (formulas (6) and (7) in \cite{Faustoetal2009}) by adding the \intextoption{pdd_fausto} option. It also implements latitude- and mean July temperature dependent ice and snow factors using formulas in \cite{Faustoetal2009}. The standard deviation of the daily variability (\intextoption{pdd_std_dev} option) is 2.53 degrees under the \intextoption{pdd_fausto} option \cite{Faustoetal2009}. See also configuration parameters with the \texttt{pdd_fausto} prefix.

\subsection{PIK}
\label{sec:surface-pik}
\optsection{\surface!\texttt{pik}}

\newcommand{\surfacemods}{Surface model modifiers}

\section{Surface model modifiers}
\label{sec:modifiers}

\subsection{Scalar temperature offsets}
\label{sec:surface-delta-temp}
\optsection{\surfacemods!\texttt{dTforcing}}

The \texttt{dTforcing} modifier implements temperature forcing using scalar
offsets and uses the \fileopt{dTforcing} option. This modifier is identical to
the corresponding atmosphere modifier, but applies offsets at a different stage
in the computation of top-surface boundary conditions needed by the ice
dynamics core.

\subsection{Temperature and mass balance anomalies}
\label{sec:temp-smb-anomalies}
\optsection{\surfacemods!\texttt{FIXME_forcing}}



\subsection{Lapse rate corrections}
\label{sec:surface-lapse-rates}
\optsection{\surfacemods!\texttt{lapse_rate}}

The \texttt{lapse_rate} modifier allows correcting ice-surface temperature and
surface mass balance using elevation lapse rates. It uses the following
options.

\begin{itemize}
\item \fileopt{surface_given_file} specifies the file containing the reference
  surface elevation field (standard name: \texttt{surface_altitude}). This file
  can contain several surface elevation records to use lapse rate corrections
  relative to time-dependent surface. If one record is provided, the reference
  surface elevation is assumed to be time-independent.
\item \intextoption{surface_given_period} gives the period, in model years, to
  use when interpreting data in the file given with
  \texttt{-surface_given_file},
\item \intextoption{surface_given_reference_year} takes the time $T$ in model
  years. The record for $t$ years in \texttt{-surface_given_file} is
  interpreted as corresponding to $t$ years since $T$.
\item \intextoption{surface_given_time_average} enables interpolating (and in
  some cases, averaging) B.C. data in time.
\item \intextoption{temp_lapse_rate} gives the temperature lapse rate, in
  $K/km$. Note that we use the following definition of the temperature lapse
  rate:
  \begin{displaymath}
    \gamma = -\frac{dT}{dz}.
  \end{displaymath}
\item \intextoption{smb_lapse_rate} gives the surface mass balance lapse rate,
  in $m/year/km$. Here, $\gamma=-\frac{dM}{dz}$.
\end{itemize}

\subsection{Surface mass flux adjustment}
\label{sec:smb-adjustment}
\optsection{\surfacemods!\texttt{forcing}}

The \texttt{forcing} modifier implements a surface mass balance adjustment
mechanism which forces ice thickness to a target thickness distribution at the
end of the run. The idea behind this mechanism is that spinup of ice sheet
models frequently requires the surface elevation to come close to measured
values at the end of a run. A simpler alternative to accomplish this, namely
option \intextoption{no_mass}, represents an unmodeled, frequently large,
violation of the mass continuity equation.

In more detail, let $H_{\text{tar}}$ be the target thickness. Let $H$ be the
time-dependent model thickness. Note that a surface model as described in this
section produces the $M$ term in the mass continuity equation
$$\frac{\partial H}{\partial t} = M - S - \nabla\cdot \mathbf{q}.$$
(Other details of this equation do not concern us here.) Option
\fileopt{force_to_thk} causes $M$ to be modified by a multiple of the
difference between the target thickness and the current thickness,
$$\Delta M = \alpha (H_{\text{tar}} - H)$$
where $\alpha>0$. We are adding mass ($\Delta M>0$) where $H_{\text{tar}} > H$
and ablating where $H_{\text{tar}} < H$. We make this mechanism stronger as the
run goes on, as follows: if $t_s$ be the start time and $t_e$ the end time for
the run then $\alpha=\alpha(t)$ where $\alpha(t) = \alpha_0 (t-t_s)/(t_e-t_s)$.

Option \fileopt{force_to_thk} identifies the file containing the target ice
thickness field. A basic run modifying surface model \texttt{constant} would
look like
\begin{verbatim}
$ pismr -i foo.nc -surface constant,forcing -force_to_thk bar.nc
\end{verbatim}%$

In this case \texttt{foo.nc} contains fields \texttt{acab} and \texttt{artm},
as normal for \texttt{-surface constant}, and \texttt{bar.nc} contains field
\texttt{thk} which will serve as the target thickness. Option
\intextoption{force_to_thk_alpha} adjusts the value of $\alpha_0$, which has a
default value specified in the \emph{Source Code Browser}
\url{\PISMBROWSERURL}.

\subsection{Anomalies}
\label{sec:surface-anomaly}
\optsection{\surfacemods!\texttt{anomaly}}

\texttt{artm_anomaly} \texttt{acab_anomaly}

\fileopt{-surface_anomaly_file}
\fileopt{-surface_anomaly_period}
\fileopt{-surface_anomaly_reference_year}


\newcommand{\atmosphere}{Atmosphere models (\texttt{-atmosphere})}
\section{Atmosphere models}
\label{sec:atmosphere}

\subsection{SeaRISE-Greenland}
\label{sec:atmosphere-searise-greenland}
\optsection{\atmosphere!\texttt{searise_greenland}}

This atmosphere model implements a longitude, latitude, and elevation dependent near-surface air temperature parameterization and a cosine yearly cycle described in \cite{Faustoetal2009} and uses a constant in time ice-equivalent precipitation field (in units of thickness per time, variable \texttt{precip}) that is read from an input (\texttt{-i} or \texttt{-boot_file}) file.

The air temperature parameterization is controlled by configuration parameters with the \texttt{snow_temp_fausto} prefix.

In addition to the temperature parameterization, it allows using the SeaRISE-Greenland formula for paleo-precipitation correction from present; a 7.3\% change of precipitation rate for every one degree Celsius of temperature change \cite{Huybrechts02}.  See \url{http://websrv.cs.umt.edu/isis/index.php/Model_Initialization#Greenland} for details.  Turn on this mechanism by using the \intextoption{paleo_precip} option.

It expects variables \texttt{precip}, latitude (\texttt{lat}), and longitude (\texttt{lon}) to be present in an input file.

\subsection{Reading atmosphere boundary conditions from a file}
\label{sec:atmosphere-given}
\optsection{\atmosphere!\texttt{given}}

This atmosphere model reads forcing fields
\begin{itemize}
\item \texttt{air_temp} and
\item \texttt{precip} (in units of ice-equivalent thickness per time)
\end{itemize}
given by the user from a file and provides them to a surface model.

The name of the file PISM will read \texttt{artm} and \texttt{precip} from is specified using the \fileopt{atmosphere_given_file} option.

A file \texttt{foo.nc} used with \texttt{-atmosphere given -atmosphere_given_file foo.nc} should contain several records;\footnote{If this file contains one record (i.e. fields corresponding to one time value only), \texttt{-atmosphere given} is essentially equivalent to \texttt{-atmosphere constant}.} the time variable (\texttt{'t'}) should describe what model time these records correspond to.

This model was created to force PISM with sampled (possibly periodic) climate data, e.g. using monthly records of \texttt{artm} and \texttt{precip}.

Currently there are two ``modifiers'' one can use with an atmosphere model.

The atmosphere \texttt{dTforcing} modifier implements temperature forcing using scalar offsets and \texttt{anomaly} modifier a mechanism applying precipitation and temperature anomalies.
\begin{itemize}
\item \fileopt{dTforcing} specifies a file containing scalar temperature
  offsets (for use with \texttt{dTforcing}, variable \texttt{delta_T}),
\item \fileopt{anomaly_temp} specifies a file containing spatially-variable
  near-surface air temperature anomalies (variable \texttt{temp_anomaly}),
  and
\item \fileopt{anomaly_precip} specifies a file containing spatially-variable
  ice-equivalent precipitation anomalies (in units of thickness per time,
  variable \texttt{precip_anomaly}).
\end{itemize}

Options \texttt{-anomaly_temp} and \texttt{-anomaly_precip} can be used to
set up a PISM run using a GCM output, essentially achieving one-way coupling.
See also the \texttt{-surface given} option, below.


\subsection{EISMINT-Greenland}
\label{sec:atmosphere-eismint-greenland}
\index[options]{\atmosphere!\texttt{eismint_greenland}}

\subsection{PIK}
\label{sec:atmosphere-pik}
\index[options]{\atmosphere!\texttt{pik}}

\newcommand{\atmospheremods}{Atmosphere modifiers (\texttt{-atmosphere})}

\section{Atmosphere model modifiers}
\label{sec:atmosphere-mods}

\subsection{Scalar temperature offsets}
\label{sec:atmosphere-delta-temp}
\optsection{\atmospheremods!\texttt{dTforcing}}

\fileopt{dTforcing}

\subsection{Scalar precipitation offsets}
\label{sec:atmosphere-delta-precip}
\optsection{\atmospheremods!\texttt{dTforcing}}

\fileopt{dPforcing}

\subsection{Lapse rate corrections}
\label{sec:atmosphere-lapse-rates}
\optsection{\atmospheremods!\texttt{lapse_rate}}

The \texttt{lapse_rate} modifier allows correcting air temperature and
precipitation using elevation lapse rates. It uses the following options.

\begin{itemize}
\item \intextoption{temp_lapse_rate} gives the temperature lapse rate, in
  $K/km$. Note that we use the following definition of the temperature lapse
  rate:
  \begin{displaymath}
    \gamma = -\frac{dT}{dz}.
  \end{displaymath}
\item \intextoption{precip_lapse_rate} gives the precipitation lapse rate, in
  $m/year/km$. Here $\gamma = -\frac{dM}{dz}$.
\item \fileopt{atmosphere_lapse_rate_file} specifies the file containing the
  reference surface elevation field (standard name:
  \texttt{surface_altitude}). This file can contain several surface elevation
  records to use lapse rate corrections relative to time-dependent surface.
  If one record is provided, the reference surface elevation is assumed to be
  time-independent.
\item \intextoption{atmosphere_lapse_rate_period} gives the period, in model
  years, to use when interpreting data in the file given with
  \texttt{-atmosphere_lapse_rate_file},
\item \intextoption{atmosphere_lapse_rate_reference_year} takes the time $T$ in
  model years. The record for $t$ years in \texttt{-atmosphere_lapse_rate_file} is
  interpreted as corresponding to $t$ years since $T$.
\end{itemize}


\subsection{Anomalies}
\label{sec:atmosphere-anomaly}
\optsection{\atmospheremods!\texttt{anomaly}}

\fileopt{dPforcing}



\newcommand{\ocean}{Ocean models (\texttt{-ocean})}

\section{Ocean models}
\label{sec:pism-ocean-models}



\subsection{Constant in time}
\label{sec:constant-time-2}
\optsection{\ocean!\texttt{constant}}

PISM includes one simple ocean model: \texttt{constant}, providing constant
(both in time and space) mass flux into the ocean and sea level elevation to
PISM's ice flow core. The mass flux is controlled by the\\
\texttt{ocean_sub_shelf_heat_flux_into_ice} configuration parameter and the
assumption that the mass flux is proportional to heat flux into ice.
Alternatively, the sub shelf basal melt rate in meters ice-equivalent per year
can be set at the command-line with \intextoption{shelf_base_melt_rate}.

\subsection{Reading forcing data from a file}
\label{sec:ocean-given}
\optsection{\ocean!\texttt{given}}

\subsection{PIK}
\label{sec:ocean-pik}
\optsection{\ocean!\texttt{pik}}
\index[options]{\ocean!\texttt{pik}}

\newcommand{\oceanmods}{Ocean model modifiers}

\section{Ocean model modifiers}
\label{sec:ocean-mods}

\subsection{Scalar sea level offsets}
\label{sec:delta-sea-level}
\optsection{\oceanmods!\texttt{dSLforcing}}

The ocean \texttt{dSLforcing} modifier implements sea level forcing. The
command-line option \fileopt{dSLforcing} is used to specify the file containing
sea level offsets:
\begin{verbatim}
$ pismr -i in.nc -ocean constant,dSLforcing -dSLforcing delta_SL.nc
\end{verbatim}%$
uses \texttt{delta_SL.nc}

\subsection{Scalar sub-shelf temperature offsets}
\label{sec:delta-subshelf-temp}
\optsection{\oceanmods!\texttt{dTforcing}}

\fileopt{ocean_dTforcing}

\subsection{Scalar sub-shelf mass flux offsets}
\label{sec:delta-subshelf-smb}
\optsection{\oceanmods!\texttt{dSBMFforcing}}

\fileopt{ocean_delta_mass_flux_file}


% References and indices
\clearpage\newpage
\bibliography{ice-bib}
\bibliographystyle{siam}

\phantomsection
\addcontentsline{toc}{section}{General Index}
\label{sect:index}
{\small \printindex }

\phantomsection
\addcontentsline{toc}{section}{Command-line options}
{ \small \printindex[options] }

\end{document}
